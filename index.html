<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<style>
    #PumpkingImage, #eyes {
        display: none;
        position: absolute; 
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
    }

    #Cup {
        border-left: 20px solid transparent;
        border-right: 20px solid transparent;
        border-top: 500px solid rgb(0, 0, 0);
        width: 200px;
        height: 0px;
    }

    #inner-Cup {
        position: relative;
        top: -495px;
        left: -15px;
        width: 190px;
        height: 0;
        border-left: 20px solid transparent;
        border-right: 20px solid transparent;
        border-top: 490px solid rgb(90, 90, 90);
    }

    #CupClientOut {        
        width: 50px;
        height: 0;
        border-left: 5px solid transparent;
        border-right: 5px solid transparent;
        border-top: 125px solid rgb(0, 0, 0);
    }

    #CupClientRequest {
        position: relative;
        top: -123.75px;
        left: -3.75px;
        width: 47.5px;
        height: 0;
        border-left: 5px solid transparent;
        border-right: 5px solid transparent;
        border-top: 122.5px solid rgb(90, 90, 90); 
    }

    #Flavor button {
        width: 120px;
        height: 120px;
    }
</style>
<body>
    <img id="PumpkingImage" src="pumpkin.png" width="600px" height="auto">
    <canvas id="eyes" style="z-index: 2; width: 600px; height: auto;"></canvas>
    <div style="position: absolute; display: flex; flex-direction: column; left: 50%; transform: translate(-50%, 0); align-items: center; width: 90%;">
        <div id="Cup"><div id="inner-Cup"></div></div>
        <h1 id="YourColor">90, 90, 90</h1>
        <div id="Flavor" style="padding: 0px; font-size: 32px;">
            <button id="1">Red</button>
            <button id="0, 1">Green</button>
            <button id="0, 0, 1">Blue</button>
            <!-- Hard Mode -->
            <button id="2, 1, 0">Pumpkin Orange <br> (2, 1, 0)</button>
            <button id="2, 0, 1">Magenda Cherry <br> (2, 0, 1)</button>
            <button id="1, 2, 0">Lime Green <br> (1, 2, 0)</button>
            <button id="1, 0, 2">Hallowen Purple <br> (1, 0, 2)</button>
            <button id="0, 2, 1">Toxic Green <br>(0, 2, 1)</button>
            <button id="0, 1, 2">Sky Blue <br> (0, 1, 2)</button>
            <button id="-1, -1, -1">Dark Chocolate <br> (-1, -1, -1)</button>
        </div>
        <button id="CheckForRightness">Check for rightness</button>
    </div>
    <div style="border: 1px solid black; width: fit-content; display: flex; flex-direction: column; align-items: center;">
        <p>Hi! I want my drink to be this color (<span id="Hint">123</span>) can you do it?</p>
        <div id="CupClientOut"><div id="CupClientRequest"></div></div>
    </div>
</body>
<script>
    // Fix for bad looking canvas:
    // https://medium.com/wdstack/fixing-html5-2d-canvas-blur-8ebe27db07da
    const canvas = document.getElementById('eyes');
    const content = canvas.getContext("2d");
    const dpr = window.devicePixelRatio || 1;

    let style_height = +getComputedStyle(canvas).getPropertyValue("height").slice(0, -2);
    let style_width = +getComputedStyle(canvas).getPropertyValue("width").slice(0, -2);

    canvas.setAttribute('height', style_height * dpr);
    canvas.setAttribute('width', style_width * dpr);

    const randomEye = {
    0: 'eye_bored2.png',
    1: 'eye_haha.png',
    2: 'eye_hm.png',
    3: 'eye_mad.png',
    4: 'eye_normal.png',
    5: 'eye_really.png',
    6: 'eye_sad.png',
    7: 'eye_scared.png',
    8: 'eye_scared2.png',
    9: 'eye_verymad.png',
    10: 'eye_what.png',
    11: 'eye_woo.png'
    };

    x = `eyes/${randomEye[Math.floor(Math.random() * 11)]}`;
    const leftEye = new Image();
    leftEye.crossOrigin = 'anonymous';
    leftEye.src = x;


    leftEye.onload = () => {
        content.drawImage(leftEye, 100, canvas.height / 3 / dpr, 162, 202);
        setTimeout(() => {
            const rightEye = new Image();
            rightEye.crossOrigin = 'anonymous';
            rightEye.src = x;
            rightEye.onload = () => {
                content.save();
                content.translate(600, 0);
                content.scale(-1, 1);
                content.drawImage(rightEye, 100, canvas.height / 3 / dpr, 162, 202);
                content.restore();
            }
        }, 10);
    }

    let lastTime = Date.now();
    let EndOfAnEra = Date.now();
    let BlackCountAfter = 0;
    let blackCountStart = 0;
    let FirstTouch = true;

    const radius = 2;
    const size = radius * 2 + 1;

    canvas.addEventListener("mousemove", (e, timestamp) => {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        const now = Date.now();
        const dt = (now - lastTime) / 1000;

        // changed code reused from my old project
            const canvasX = x * dpr;
            const canvasY = y * dpr;

            if (FirstTouch) {
                BlackCountStart = CompareBlackPixels();
                FirstTouch = false;
            }

            BlackCountAfter = CompareBlackPixels();
            if ((BlackCountAfter / BlackCountStart) * 100 <= 5) {
                temp = (now - EndOfAnEra) / 1000;
                console.log("You finished carving a pumpkin in " + temp + " sec");
            }
            

            const pixel = content.getImageData(canvasX - radius, canvasY - radius, size, size).data;
            
            for (let i = 0; i < pixel.length; i += 4) {
                const r = pixel[i];
                const g = pixel[i + 1];
                const b = pixel[i + 2];
                const a = pixel[i + 3];

                if (r < 10 && g < 10 && b < 10 && a > 128) {
                    content.fillStyle = "rgb(255, 0, 0)";
                    content.beginPath();
                    content.arc(x, y, 10, 0, Math.PI * 2);
                    content.fill();
                    break;
                }
            }

            lastTime = now;
        });

        function CompareBlackPixels() {
            let blackCount = 0;
            const ImageData = content.getImageData(0, 0, canvas.width, canvas.height);
            const data = ImageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                const a = data[i + 3];

                if (r < 10 && g < 10 && b < 10 && a > 128) {
                    blackCount++;
                }
            }
            console.log("There is " + blackCount + " black pixels");
            return blackCount;
        };

        let holdTimeout = null;
        let wait = 100;
        const buttons = document.querySelectorAll('#Flavor button');
        buttons.forEach(b => {
            function press() {
                    const numbers = b.id.split(',').map(num => Number(num.trim()));
                    DrinkMaking(...numbers);
                    
                    wait = Math.max(20, wait - 3);
                    holdTimeout = setTimeout(() => press(), wait);              
                }

            b.addEventListener("mousedown", () => {
                if (!holdTimeout) {
                    wait = 100;
                    press();       
                }
            });

            b.addEventListener("mouseup", () => {
                clearTimeout(holdTimeout);
                holdTimeout = null;
                wait = 100;
            });
        });

        const Cup = document.getElementById('inner-Cup');
        const YC = document.getElementById('YourColor');
        let rc = gc = bc = 0;
        // c - is for client
        let r = g = b = 90;
        function DrinkMaking(rp = 0, gp = 0, bp = 0) {
            console.log(rp, gp, bp);
            r += rp;
            g += gp;
            b += bp;
            YC.textContent = `${r}, ${g}, ${b}`;
            Cup.style.borderTop = `490px solid rgb(${r}, ${g}, ${b})`;
        }
        
        const CupClient = document.getElementById('CupClientRequest');
        function ClientRequest() {
            rc = Math.floor(Math.random() * 255);
            gc = Math.floor(Math.random() * 255);
            bc = Math.floor(Math.random() * 255);
            temp = Math.floor(Math.random() * 3);
            if (temp == 0) {
                document.getElementById("Hint").textContent = `${rc}, ${'*'.repeat(String(gc).length)}, ${'*'.repeat(String(bc).length)}`;
            } else if (temp == 1) {
                document.getElementById("Hint").textContent = `${'*'.repeat(String(rc).length)}, ${gc}, ${'*'.repeat(String(bc).length)}`;    
            } else {
                document.getElementById("Hint").textContent = `${'*'.repeat(String(rc).length)}, ${'*'.repeat(String(gc).length)}, ${bc}`
            }
            CupClient.style.borderTop = `122.5px solid rgb(${rc}, ${gc}, ${bc})`;
            console.log(rc, gc, bc);
        }

        ClientRequest();

        document.getElementById("CheckForRightness").onclick = function() {
            const distance = Math.sqrt(
                (rc - r)**2 +
                (gc - g)**2 +
                (bc - b)**2
            );

            const maxDistance = Math.sqrt(3 * 255 ** 2);

            const procent = (1 - distance / maxDistance) * 100;
            console.log(procent.toFixed(2));
        }
</script>
</html>